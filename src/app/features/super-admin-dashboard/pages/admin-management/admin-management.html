<div class="admin-management-page">
  <!-- Header -->
  <div class="page-header">
    <div class="header-left">
      <h1 class="page-title">ADMIN MANAGEMENT</h1>
      <p class="page-subtitle">Manage system administrators and their roles</p>
    </div>
    <div class="header-actions">
      @if (selectedCount() > 0) {
        <div class="bulk-actions">
          <span class="selected-count">{{ selectedCount() }} selected</span>
          <button
            tuiButton
            appearance="secondary"
            size="l"
            class="bulk-button"
            (click)="openBulkRoleUpdateModal()"
          >
            <tui-icon icon="@tui.edit-2" />
            Update Roles
          </button>
          <button
            tuiButton
            appearance="secondary"
            size="l"
            class="bulk-delete-button"
            (click)="openBulkDeleteModal()"
          >
            <tui-icon icon="@tui.trash-2" />
            Delete Selected
          </button>
        </div>
      }
      <button
        tuiButton
        appearance="primary"
        size="l"
        class="create-button"
        (click)="openCreateModal()"
      >
        <tui-icon icon="@tui.plus" />
        Create Admin
      </button>
    </div>
  </div>

  <!-- Filters Card -->
  <div tuiCardLarge class="filters-card">
    <div class="filters-grid">
      <!-- Search -->
      <div class="filter-item search-filter">
        <label tuiLabel>Search</label>
        <tui-textfield>
          <input
            tuiTextfield
            type="text"
            placeholder="Search by name, email..."
            [value]="searchTerm()"
            (input)="onSearchChange($any($event.target).value)"
          />
          <tui-icon icon="@tui.search" />
        </tui-textfield>
      </div>

      <!-- Role Filter -->
      <div class="filter-item">
        <label tuiLabel>Role</label>
        <select
          class="filter-select"
          [value]="roleFilter()"
          (change)="onRoleFilterChange($any($event.target).value)"
        >
          <option value="all">All Roles</option>
          <option value="super_admin">Super Admin</option>
          <option value="league_admin">League Admin</option>
          <option value="team_admin">Team Admin</option>
          <option value="content_admin">Content Admin</option>
          <option value="game_admin">Game Admin</option>
        </select>
      </div>

      <!-- Team Filter (only show when Team Admin is selected) -->
      @if (roleFilter() === 'team_admin' && teams().length > 0) {
        <div class="filter-item">
          <label tuiLabel>Team</label>
          <select
            class="filter-select"
            [value]="teamFilter()"
            (change)="onTeamFilterChange($any($event.target).value)"
          >
            <option value="all">All Teams</option>
            @for (team of teams(); track team.id) {
              <option [value]="team.id">{{ team.name }}</option>
            }
          </select>
        </div>
      }

      <!-- Status Filter -->
      <div class="filter-item">
        <label tuiLabel>Status</label>
        <select
          class="filter-select"
          [value]="statusFilter()"
          (change)="onStatusFilterChange($any($event.target).value)"
        >
          <option value="all">All Status</option>
          <option value="active">Active</option>
          <option value="inactive">Inactive</option>
        </select>
      </div>

      <!-- Stats -->
      <div class="filter-stats">
        <div class="stat-item">
          <span class="stat-label">Total</span>
          <span class="stat-value">{{ totalAdmins() }}</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Showing</span>
          <span class="stat-value">{{ displayedAdmins().length }}</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Table Card -->
  @if (loading()) {
    <div class="loading-container">
      <tui-loader size="m"></tui-loader>
    </div>
  } @else if (displayedAdmins().length === 0) {
    <div tuiCardLarge class="empty-state">
      <tui-icon icon="@tui.users" class="empty-icon" />
      <h3>No administrators found</h3>
      <p>Try adjusting your filters or create a new admin</p>
      <button tuiButton appearance="primary" size="m" (click)="openCreateModal()">
        <tui-icon icon="@tui.plus" />
        Create Admin
      </button>
    </div>
  } @else {
    <div tuiCardLarge class="table-card">
      <div class="table-wrapper">
        <table tuiTable [columns]="columns" class="admins-table">
          <thead>
          <tr tuiThGroup>
            <th *tuiHead="'select'" tuiTh class="select-header">
              <input
                type="checkbox"
                class="select-checkbox"
                [checked]="isAllSelected()"
                [indeterminate]="isSomeSelected()"
                (change)="toggleSelectAll()"
              />
            </th>
            <th *tuiHead="'avatar'" tuiTh></th>
            <th *tuiHead="'name'" tuiTh class="sortable-header" (click)="onSort('name')">
              <span class="header-content">
                Name
                @if (sortColumn() === 'name') {
                  <tui-icon [icon]="sortDirection() === 'asc' ? '@tui.chevron-up' : '@tui.chevron-down'" class="sort-icon" />
                }
              </span>
            </th>
            <th *tuiHead="'email'" tuiTh class="sortable-header" (click)="onSort('email')">
              <span class="header-content">
                Email
                @if (sortColumn() === 'email') {
                  <tui-icon [icon]="sortDirection() === 'asc' ? '@tui.chevron-up' : '@tui.chevron-down'" class="sort-icon" />
                }
              </span>
            </th>
            <th *tuiHead="'role'" tuiTh class="sortable-header" (click)="onSort('role')">
              <span class="header-content">
                Role
                @if (sortColumn() === 'role') {
                  <tui-icon [icon]="sortDirection() === 'asc' ? '@tui.chevron-up' : '@tui.chevron-down'" class="sort-icon" />
                }
              </span>
            </th>
            <th *tuiHead="'status'" tuiTh class="sortable-header" (click)="onSort('status')">
              <span class="header-content">
                Status
                @if (sortColumn() === 'status') {
                  <tui-icon [icon]="sortDirection() === 'asc' ? '@tui.chevron-up' : '@tui.chevron-down'" class="sort-icon" />
                }
              </span>
            </th>
            <th *tuiHead="'lastLogin'" tuiTh class="sortable-header" (click)="onSort('lastLogin')">
              <span class="header-content">
                Last Login
                @if (sortColumn() === 'lastLogin') {
                  <tui-icon [icon]="sortDirection() === 'asc' ? '@tui.chevron-up' : '@tui.chevron-down'" class="sort-icon" />
                }
              </span>
            </th>
            <th *tuiHead="'actions'" tuiTh class="actions-header">Actions</th>
          </tr>
          </thead>
          <tbody tuiTbody [data]="displayedAdmins()">
            @for (admin of displayedAdmins(); track admin.id) {
              <tr tuiTr>
                <td *tuiCell="'select'" tuiTd>
                  <input
                    type="checkbox"
                    class="select-checkbox"
                    [checked]="isAdminSelected(admin.id)"
                    (change)="toggleSelectAdmin(admin.id)"
                  />
                </td>
                <td *tuiCell="'avatar'" tuiTd>
                  <tui-avatar size="s" class="admin-avatar">
                    {{ getInitials(admin.fullName) }}
                  </tui-avatar>
                </td>
                <td *tuiCell="'name'" tuiTd>
                  <div class="name-cell">
                    <span class="admin-name">{{ admin.fullName || 'N/A' }}</span>
                    @if (admin.username) {
                      <span class="admin-username">&#64;{{ admin.username }}</span>
                    }
                  </div>
                </td>
                <td *tuiCell="'email'" tuiTd>
                  <span class="admin-email">{{ admin.email || 'N/A' }}</span>
                </td>
                <td *tuiCell="'role'" tuiTd>
                  @if (admin.role) {
                    <span
                      class="role-badge"
                      [style.background-color]="getRoleBadgeColor(admin.role.name) + '20'"
                      [style.color]="getRoleBadgeColor(admin.role.name)"
                    >
                      {{ getRoleDisplayName(admin.role.name) }}
                    </span>
                  } @else {
                    <span class="role-badge" style="background-color: #6b728020; color: #6b7280">
                      No Role
                    </span>
                  }
                </td>
                <td *tuiCell="'status'" tuiTd>
                  <div class="status-toggle">
                    <label class="switch-wrapper">
                      <input
                        tuiSwitch
                        type="checkbox"
                        [ngModel]="admin.isActive"
                        (ngModelChange)="toggleAdminStatus(admin)"
                      />
                    </label>
                    <span [class.active]="admin.isActive" [class.inactive]="!admin.isActive">
                      {{ admin.isActive ? 'Active' : 'Inactive' }}
                    </span>
                  </div>
                </td>
                <td *tuiCell="'lastLogin'" tuiTd>
                  <span [class]="admin.lastLogin ? 'last-login' : 'no-login'">
                    {{ formatDate(admin.lastLogin || '') }}
                  </span>
                </td>
                <td *tuiCell="'actions'" tuiTd>
                  <div class="action-buttons">
                    <button
                      tuiIconButton
                      appearance="flat"
                      size="s"
                      class="edit-button"
                      [tuiHint]="'Edit admin'"
                      (click)="openEditModal(admin)"
                    >
                      <tui-icon icon="@tui.edit-2" />
                    </button>
                    <button
                      tuiIconButton
                      appearance="flat"
                      size="s"
                      class="delete-button"
                      [tuiHint]="'Delete admin'"
                      (click)="openDeleteModal(admin)"
                    >
                      <tui-icon icon="@tui.trash-2" />
                    </button>
                  </div>
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      @if (totalAdmins() > pageSize()) {
        <div class="pagination">
          <button
            tuiButton
            appearance="secondary"
            size="s"
            [disabled]="currentPage() === 1"
            (click)="onPageChange(currentPage() - 1)"
          >
            <tui-icon icon="@tui.chevron-left" />
            Previous
          </button>
          <span class="page-info">
            Page {{ currentPage() }} of {{ totalPages() }}
          </span>
          <button
            tuiButton
            appearance="secondary"
            size="s"
            [disabled]="!hasMore()"
            (click)="onPageChange(currentPage() + 1)"
          >
            Next
            <tui-icon icon="@tui.chevron-right" />
          </button>
        </div>
      }
    </div>
  }
</div>

<!-- Create Admin Modal -->
@if (showCreateModal()) {
  <div class="modal-overlay" (click)="closeCreateModal()">
    <div tuiCardLarge class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>CREATE NEW ADMIN</h2>
        <button tuiIconButton appearance="flat" size="s" (click)="closeCreateModal()">
          <tui-icon icon="@tui.x" />
        </button>
      </div>

      <div class="modal-body">
        @if (createError()) {
          <div class="error-message">
            <tui-icon icon="@tui.alert-circle" />
            {{ createError() }}
          </div>
        }

        <form class="admin-form">
          <div class="form-group">
            <label tuiLabel>Full Name *</label>
            <tui-textfield>
              <input
                tuiTextfield
                type="text"
                placeholder="Enter full name"
                [(ngModel)]="createForm().fullName"
                name="fullName"
              />
            </tui-textfield>
          </div>

          <div class="form-group">
            <label tuiLabel>Email Address *</label>
            <tui-textfield>
              <input
                tuiTextfield
                type="email"
                placeholder="admin@gamepulse.com"
                [(ngModel)]="createForm().email"
                name="email"
              />
            </tui-textfield>
          </div>

          <div class="form-group">
            <label tuiLabel>Password *</label>
            <tui-textfield>
              <input
                tuiTextfield
                type="password"
                placeholder="Minimum 8 characters"
                [(ngModel)]="createForm().password"
                name="password"
              />
            </tui-textfield>
          </div>

          <div class="form-group">
            <label tuiLabel>Role *</label>
            <select class="form-select" [(ngModel)]="createForm().roleId" name="roleId">
              @for (role of roles(); track role.id) {
                <option [value]="role.id">{{ role.name }}</option>
              }
            </select>
          </div>

          @if (createForm().roleId === 3 && teams().length > 0) {
            <div class="form-group">
              <label tuiLabel>Team (Optional)</label>
              <select class="form-select" [(ngModel)]="createForm().teamId" name="teamId">
                <option [value]="undefined">No team</option>
                @for (team of teams(); track team.id) {
                  <option [value]="team.id">{{ team.name }}</option>
                }
              </select>
            </div>
          }
        </form>
      </div>

      <div class="modal-footer">
        <button tuiButton appearance="secondary" size="m" (click)="closeCreateModal()">
          Cancel
        </button>
        <button
          tuiButton
          appearance="primary"
          size="m"
          [disabled]="loading()"
          (click)="onCreateSubmit()"
        >
          @if (loading()) {
            <tui-loader size="s"></tui-loader>
          }
          Create Admin
        </button>
      </div>
    </div>
  </div>
}

<!-- Edit Admin Modal -->
@if (showEditModal() && selectedAdmin()) {
  <div class="modal-overlay" (click)="closeEditModal()">
    <div tuiCardLarge class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>EDIT ADMIN</h2>
        <button tuiIconButton appearance="flat" size="s" (click)="closeEditModal()">
          <tui-icon icon="@tui.x" />
        </button>
      </div>

      <div class="modal-body">
        @if (editError()) {
          <div class="error-message">
            <tui-icon icon="@tui.alert-circle" />
            {{ editError() }}
          </div>
        }

        <form class="admin-form">
          <div class="form-group">
            <label tuiLabel>Full Name</label>
            <tui-textfield>
              <input
                tuiTextfield
                type="text"
                placeholder="Enter full name"
                [value]="editForm().fullName"
                (input)="onFullNameChange($any($event.target).value)"
                name="fullName"
              />
            </tui-textfield>
          </div>

          <div class="form-group">
            <label tuiLabel>Role</label>
            <select
              class="form-select"
              [ngModel]="editForm().roleId"
              (ngModelChange)="onRoleChange($event)"
              name="roleId"
            >
              @for (role of roles(); track role.id) {
                <option [value]="role.id">{{ role.name }}</option>
              }
            </select>
          </div>

          @if (shouldShowTeamDropdownInEdit()) {
            <div class="form-group">
              <label tuiLabel>Team</label>
              <select
                class="form-select"
                [ngModel]="editForm().teamId"
                (ngModelChange)="onTeamChange($event)"
                name="teamId"
              >
                <option [value]="undefined">No team</option>
                @for (team of teams(); track team.id) {
                  <option [value]="team.id">{{ team.name }}</option>
                }
              </select>
            </div>
          }

          <div class="form-group">
            <label class="checkbox-label">
              <input
                tuiSwitch
                type="checkbox"
                [ngModel]="editForm().isActive"
                (ngModelChange)="onActiveChange($event)"
                name="isActive"
              />
              <span>Active</span>
            </label>
          </div>
        </form>
      </div>

      <div class="modal-footer">
        <button tuiButton appearance="secondary" size="m" (click)="closeEditModal()">
          Cancel
        </button>
        <button
          tuiButton
          appearance="primary"
          size="m"
          [disabled]="loading()"
          (click)="onEditSubmit()"
        >
          @if (loading()) {
            <tui-loader size="s"></tui-loader>
          }
          Save Changes
        </button>
      </div>
    </div>
  </div>
}

<!-- Delete Admin Modal -->
@if (showDeleteModal() && selectedAdmin()) {
  <div class="modal-overlay" (click)="closeDeleteModal()">
    <div tuiCardLarge class="modal-content modal-delete" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>DELETE ADMIN</h2>
        <button tuiIconButton appearance="flat" size="s" (click)="closeDeleteModal()">
          <tui-icon icon="@tui.x" />
        </button>
      </div>

      <div class="modal-body">
        @if (deleteError()) {
          <div class="error-message">
            <tui-icon icon="@tui.alert-circle" />
            {{ deleteError() }}
          </div>
        }

        <div class="delete-warning">
          <tui-icon icon="@tui.alert-triangle" class="warning-icon" />
          <p>
            Are you sure you want to delete
            <strong>{{ selectedAdmin()!.fullName }}</strong>?
          </p>
          <p class="warning-text">This action cannot be undone.</p>
        </div>
      </div>

      <div class="modal-footer">
        <button tuiButton appearance="secondary" size="m" (click)="closeDeleteModal()">
          Cancel
        </button>
        <button
          tuiButton
          appearance="primary"
          size="m"
          class="delete-confirm-button"
          [disabled]="loading()"
          (click)="onDeleteConfirm()"
        >
          @if (loading()) {
            <tui-loader size="s"></tui-loader>
          }
          Delete Admin
        </button>
      </div>
    </div>
  </div>
}

<!-- Bulk Delete Modal -->
@if (showBulkDeleteModal()) {
  <div class="modal-overlay" (click)="closeBulkDeleteModal()">
    <div tuiCardLarge class="modal-content modal-delete" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>BULK DELETE ADMINS</h2>
        <button tuiIconButton appearance="flat" size="s" (click)="closeBulkDeleteModal()">
          <tui-icon icon="@tui.x" />
        </button>
      </div>

      <div class="modal-body">
        <div class="delete-warning">
          <tui-icon icon="@tui.alert-triangle" class="warning-icon" />
          <p>
            Are you sure you want to delete
            <strong>{{ selectedCount() }} admin(s)</strong>?
          </p>
          <p class="warning-text">This action cannot be undone.</p>
        </div>
      </div>

      <div class="modal-footer">
        <button tuiButton appearance="secondary" size="m" (click)="closeBulkDeleteModal()">
          Cancel
        </button>
        <button
          tuiButton
          appearance="primary"
          size="m"
          class="delete-confirm-button"
          [disabled]="bulkActionLoading()"
          (click)="onBulkDeleteConfirm()"
        >
          @if (bulkActionLoading()) {
            <tui-loader size="s"></tui-loader>
          }
          Delete {{ selectedCount() }} Admin(s)
        </button>
      </div>
    </div>
  </div>
}

<!-- Bulk Role Update Modal -->
@if (showBulkRoleUpdateModal()) {
  <div class="modal-overlay" (click)="closeBulkRoleUpdateModal()">
    <div tuiCardLarge class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>UPDATE ROLES</h2>
        <button tuiIconButton appearance="flat" size="s" (click)="closeBulkRoleUpdateModal()">
          <tui-icon icon="@tui.x" />
        </button>
      </div>

      <div class="modal-body">
        <p class="bulk-info">Update role for {{ selectedCount() }} selected admin(s)</p>
        
        <form class="admin-form">
          <div class="form-group">
            <label tuiLabel>New Role *</label>
            <select
              class="form-select"
              [ngModel]="bulkRoleId()"
              (ngModelChange)="bulkRoleId.set($event); bulkTeamId.set(undefined)"
              name="bulkRoleId"
            >
              <option [value]="undefined">Select a role...</option>
              @for (role of roles(); track role.id) {
                <option [value]="role.id">{{ role.name }}</option>
              }
            </select>
          </div>

          @if (shouldShowTeamDropdownInBulk()) {
            <div class="form-group">
              <label tuiLabel>Team (Optional)</label>
              <select
                class="form-select"
                [ngModel]="bulkTeamId()"
                (ngModelChange)="bulkTeamId.set($event)"
                name="bulkTeamId"
              >
                <option [value]="undefined">No team</option>
                @for (team of teams(); track team.id) {
                  <option [value]="team.id">{{ team.name }}</option>
                }
              </select>
            </div>
          }
        </form>
      </div>

      <div class="modal-footer">
        <button tuiButton appearance="secondary" size="m" (click)="closeBulkRoleUpdateModal()">
          Cancel
        </button>
        <button
          tuiButton
          appearance="primary"
          size="m"
          [disabled]="bulkActionLoading() || !bulkRoleId()"
          (click)="onBulkRoleUpdateConfirm()"
        >
          @if (bulkActionLoading()) {
            <tui-loader size="s"></tui-loader>
          }
          Update {{ selectedCount() }} Admin(s)
        </button>
      </div>
    </div>
  </div>
}
